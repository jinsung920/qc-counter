<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>QC Counter (CHOI)</title>

  <!-- PWA install support -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0b1020">

  <style>
    :root {
      --bg:#0f172a; --panel:#0b1220; --card:#101827; --line:#1f2937;
      --text:#e5e7eb; --muted:#94a3b8; --ok:#22c55e; --ng:#ef4444;
      --accent:#3b82f6; --warn:#f59e0b;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin:0;
      background: linear-gradient(180deg,#0b1020,#0a0f1b);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Helvetica, Arial, sans-serif;
      min-height: 100vh;
      overflow: auto; /* allow page scroll if needed (user requested to remove scroll lock) */
    }

    /* Splash */
    .splash {
      position: fixed; inset: 0;
      display:flex; align-items:center; justify-content:center;
      background: radial-gradient(1100px 700px at 50% 10%, rgba(59,130,246,.18), transparent 55%),
                  linear-gradient(180deg,#0b1020,#0a0f1b);
      z-index: 9999;
      transition: opacity 320ms ease, transform 320ms ease;
    }
    .splash.hide { opacity: 0; transform: translateY(-6px); pointer-events:none; }
    .splashCard {
      text-align:center;
      padding: 22px 22px;
      border: 1px solid rgba(148,163,184,.25);
      background: rgba(17,24,39,.55);
      border-radius: 22px;
      box-shadow: 0 20px 70px rgba(0,0,0,.55);
      min-width: min(520px, 92vw);
    }
    .splashLogo {
      width: min(320px, 70vw);
      height: auto;
      display: block;
      margin: 0 auto 14px auto;
    }
    .splashTitle { font-size: clamp(26px, 4.2vw, 42px); font-weight: 1000; letter-spacing: .2px; margin: 0 0 10px 0; }
    .splashMade { font-size: clamp(18px, 3vw, 26px); font-weight: 900; color:#cbd5e1; margin: 0; }

    /* Layout container */
    .container {
      max-width: 1600px;           /* use more width on large tablets */
      width: 100%;
      margin: 0 auto;
      padding: 16px;
      height: 100dvh;
      height: 100vh; /* fallback */
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    header {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      flex: 0 0 auto;
    }
    .title { font-size: 18px; font-weight: 900; letter-spacing:.2px; }
    .muted { color: var(--muted); }

    .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .langSelect { background:#0a1325; border:1px solid #1f2937; color:var(--text); padding:8px 10px; border-radius:10px; font-size:13px; font-weight:700 }

    .row {
      display:flex;
      gap:12px;
      flex: 1 1 auto;
      min-height: 0; /* allow children to size within viewport */
      flex-wrap: nowrap; /* keep both panels visible side-by-side by default */
      align-items: stretch;
    }
    .panel {
      background: rgba(17,24,39, .62);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 10px 34px rgba(0,0,0,.35);
      min-height: 0;
    }

    /* make panels manage their own inner sizing to avoid page scroll */
    .panel.left,
    .panel.right {
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: visible; /* do not clip; allow contents to size naturally */
    }

    /* Panels sizing: keep both visible, but don't make right too narrow on large screens */
    .left {
      flex: 1.25 1 560px;
      min-width: 520px;
      align-self: stretch;
    }
    .right {
      flex: 1 1 520px;          /* allow right panel to grow and fill blank space */
      min-width: 420px;
      max-width: none;          /* remove previous 260px cap */
      align-self: stretch;
    }

    @media (max-width: 980px){
      /* On narrower displays, give left more priority */
      .left{ flex: 1.35 1 520px; min-width: 420px; }
      .right{ flex: 0.95 1 380px; min-width: 320px; }
    }

    @media (max-width: 820px) and (orientation: portrait){
      /* Portrait phones/tablets: stack panels */
      .left, .right{ min-width: 0; }
    }

    .btn {
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      cursor:pointer; user-select:none; touch-action:manipulation;
      border:1px solid #273244; background:#0c162b; color:var(--text);
      padding:12px 14px; border-radius:16px; font-weight:900;
    }
    .btn:active { transform: translateY(1px); }
    #btnSettings{ width:44px; height:44px; padding:0; border-radius:14px; font-size:18px; }
    .btn.ok { background: rgba(34,197,94,.18); border-color:#1e8a55; }
    .btn.ng { background: rgba(239,68,68,.18); border-color:#a23232; }
    .btn.primary { background: linear-gradient(180deg,#2a4fa0,#1f3d7a); border-color:#335fc1; }
    .btn.warn { background: rgba(245,158,11,.16); border-color:#9a6a17; }

    /* BIG action buttons for shopfloor (use left space aggressively) */
    .actionGrid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr; /* fill left panel vertically (large screens) */
      gap: 14px;
      margin-top: 10px;
      flex: 1 1 auto;
      min-height: 0;
    }

    /* push the hint/state area to the bottom so empty space disappears */
    .panel.left .stateRow{ margin-top: auto; }

    .btn.big {
      width:100%;
      /* let grid rows decide the height; keep a safe minimum */
      min-height: 86px;
      padding: clamp(14px, 3.6vh, 34px) clamp(14px, 2.2vw, 22px);
      font-size: clamp(22px, 4.2vw, 54px);
      border-radius: 24px;
      letter-spacing: .35px;
      line-height: 1.05;
      white-space: normal;
    }

    /* keep buttons in 2 columns on most phones; stack only on very narrow screens */
    @media (max-width: 420px){
      .actionGrid{
        grid-template-columns: 1fr;
        grid-template-rows: repeat(4, auto);
      }
      .btn.big{ min-height: 78px; font-size: clamp(20px, 6vw, 34px); }
    }

    /* small height devices: reduce paddings so everything fits */
    @media (max-height: 720px){
      .container{ padding: 12px; gap: 10px; }
      header{ gap: 10px; }
      .panel{ padding: 12px; }
      .actionGrid{ gap: 10px; }
      .btn.big{ min-height: clamp(72px, 16vh, 120px); padding: clamp(12px, 3.2vh, 26px) 14px; }
    }

    /* very short screens (common on phones in landscape): compress header + buttons */
    @media (max-height: 520px){
      [data-i18n="subtitle"]{ display:none; }
      .toolbar .btn{ padding:8px 10px; border-radius:12px; font-size:12px; }
      .langSelect{ padding:6px 8px; border-radius:10px; font-size:12px; }
      .panel{ padding: 10px; }
      .actionGrid{ gap: 8px; flex: 0 0 auto; grid-template-rows: auto auto; }
      .btn.big{ min-height: 64px; padding: 10px 12px; font-size: clamp(18px, 3.4vw, 32px); border-radius:20px; }

      /* prevent hint area from overlapping buttons on small landscape phones */
      .panel.left .stateRow{ margin-top: 10px; }
      .panel.left{ overflow:auto; }
      .hint{ font-size:11px; line-height:1.25; }

      /* keep hour table usable */
      .tableBox{ min-height: 180px; }
    }

    /* when screen is narrow AND portrait, stack panels (landscape keeps side-by-side) */
    @media (max-width: 820px) and (orientation: portrait){
      .row{ flex-wrap: wrap; }
      .left{ flex: 1 1 100%; min-width: 0; }
      .right{ flex: 1 1 100%; min-width: 0; }
      .panel.right{ max-height: none; }
    }

    .stateRow { display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .stateBadge {
      display:inline-flex; align-items:center; gap:6px;
      border:1px dashed #42516b; background:#0a1325;
      padding:10px 12px; border-radius:999px; font-weight:900;
      font-size: 14px;
    }
    .state-ok { color: var(--ok); }
    .state-ng { color: var(--ng); }
    .state-none { color: var(--muted); }

    .hint { font-size:12px; color:var(--muted); margin-top:6px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Consolas, Menlo, monospace; background:#0b1220; border:1px solid var(--line); padding:2px 6px; border-radius:6px; }

    /* compact tables on right */
    table { width:100%; border-collapse: collapse; }
    th, td { padding:7px 6px; border-bottom:1px solid var(--line); text-align:left; font-size:12.5px; }
    thead th { position: sticky; top:0; background:#0d1424; font-size:12px; }

    /* Right table box: fill ALL remaining space in the right panel */
    .tableBox{
      border:1px solid var(--line);
      border-radius:12px;
      overflow:auto;
      flex: 1 1 0;     /* take all remaining vertical space */
      min-height: 0;   /* allow it to shrink without creating blank space */
    }

    /* Ensure right panel doesn't leave unused vertical space */
    .panel.right{ overflow: hidden; }

    .stat { display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin: 6px 0 10px 0; }
    .chip { border:1px solid #334155; border-radius:999px; padding:6px 8px; color:#cbd5e1; background:#0a1325; font-size:12px; }
    .okT { color:var(--ok); }
    .ngT { color:var(--ng); }

    /* Dialog */
    dialog {
      border:none; border-radius:18px; padding:0;
      width:min(520px, 92vw);
      background:#0a1325; color:var(--text);
      box-shadow: 0 18px 60px rgba(0,0,0,.55);
    }
    .dlgWrap { padding:16px; border:1px solid var(--line); border-radius:18px; }
    .dlgTitle { font-size:16px; font-weight:900; margin:0 0 8px 0; }
    .dlgMsg { margin:0 0 14px 0; color:#cbd5e1; }
    .dlgBtns { display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; }

    .fieldLabel { font-size:12px; color:#9fb0c8; font-weight:800; margin: 10px 0 6px 0; }
    input[type="password"]{
      width:100%;
      background:#0a1325;
      border:1px solid #1f2937;
      color:var(--text);
      padding:12px;
      border-radius:12px;
      font-size:16px;
      font-weight:800;
      outline:none;
    }
    input[type="password"]:focus{border-color:#334155; box-shadow:0 0 0 2px rgba(59,130,246,.25)}
  
    /* Meta fields (Operator / Location) */
    .metaFields{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .metaFields .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size: 12px;
      color: var(--muted);
    }
    .metaFields input,
    .metaFields select{
      width:100%;
      background: rgba(16,24,39,.8);
      color: var(--text);
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 16px;
      outline: none;
    }
    .metaFields input:focus,
    .metaFields select:focus{
      border-color: rgba(59,130,246,.8);
      box-shadow: 0 0 0 3px rgba(59,130,246,.15);
    }
    .syncRow{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
      user-select:none;
    }
    .syncDot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--muted);
      box-shadow: 0 0 0 3px rgba(148,163,184,.12);
    }
    .syncDot.ok{ background: var(--ok); box-shadow: 0 0 0 3px rgba(34,197,94,.14); }
    .syncDot.warn{ background: var(--warn); box-shadow: 0 0 0 3px rgba(245,158,11,.14); }
    .syncDot.ng{ background: var(--ng); box-shadow: 0 0 0 3px rgba(239,68,68,.14); }

    @media (max-width: 900px){
      .metaFields{ grid-template-columns: 1fr; }
    }

  
    /* NG Reason modal (with Category + Search + Top5) */
    #dlgNg .dlgWrap { max-width: min(820px, 94vw); }
    .ngToolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    .ngToolbar select, .ngToolbar input{
      background:#0a1325; border:1px solid #1f2937; color:var(--text);
      padding:10px 12px; border-radius:12px; font-size:14px; font-weight:800;
    }
    .ngToolbar input{ flex:1 1 260px; min-width: 220px; }
    .ngToolbar select{ flex:0 0 260px; min-width: 220px; }
    .ngSectionTitle { margin: 12px 0 8px 0; font-size: 13px; font-weight: 900; color:#cbd5e1; }
    .ngList { border:1px solid #223046; background:#0a1325; border-radius:14px; padding:10px; max-height: 38vh; overflow:auto; }
    .ngGroup { margin: 10px 0 6px 0; font-weight: 1000; color:#93c5fd; }
    .ngItemBtn {
      width:100%;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:10px 12px; margin: 6px 0;
      border-radius:12px; border:1px solid #24324a; background:#0c162b; color:var(--text);
      font-weight:900; cursor:pointer;
    }
    .ngItemBtn:hover { border-color:#3a5aa6; }
    .ngItemSub { font-size:12px; color: var(--muted); font-weight:800; }
    .ngPillsRow { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .ngAddRow { display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    .ngAddRow input, .ngAddRow select{
      background:#0a1325; border:1px solid #1f2937; color:var(--text);
      padding:10px 12px; border-radius:12px; font-size:14px; font-weight:800;
    }
    .ngAddRow input{ flex: 1 1 280px; min-width: 220px; }
    .ngAddRow select{ flex: 0 0 260px; min-width: 220px; }
    #ngReasonLine { display:none; margin-top:6px; }
    .chipStrong { font-weight: 900; }

  </style>
</head>
<body>
  <!-- Splash: logo 1.5s → Made by CHOI 1.5s (total 3s) on app start -->
  <div class="splash" id="splash" aria-hidden="true">
    <div class="splashCard">
      <!-- Place your company logo file as ./logo.png in the same folder -->
      <img id="splashLogo" src="./logo.png" alt="Company Logo" class="splashLogo" />

      <!-- Text phase (hidden first, shown after 1.5s) -->
      <div id="splashTextWrap" style="display:none">
        <h1 class="splashTitle">QC Counter (CHOI)</h1>
        <p class="splashMade">Made by CHOI</p>
      </div>
    </div>
  </div>

  <div class="container">
    <header>
      <div>
        <div class="title" data-i18n="title">QC Counter (CHOI)</div>
        <div class="muted" data-i18n="subtitle">판정 선택 후 Check를 누르면 1건이 기록됩니다. (오른쪽은 시간대별 누계)</div>
      </div>
      <div class="toolbar">
        <span class="chip" id="deviceChip">Device: -</span>
        <button class="btn" id="btnSettings" title="Settings" aria-label="Settings">⚙️</button>
        <label class="muted" style="display:flex; align-items:center; gap:8px">
          <span data-i18n="langLabel">언어</span>
          <select id="lang" class="langSelect">
            <option value="ko">한국어</option>
            <option value="vi">Tiếng Việt</option>
          </select>
        </label>
        <button class="btn" id="btnExport" data-i18n="export">CSV 내보내기</button>
        <button class="btn warn" id="btnClear" data-i18n="clear">오늘 데이터 삭제</button>
      </div>
    </header>

    <div class="row">
      <section class="panel left">
        <h3 style="margin:0 0 8px 0" data-i18n="panelLeft">판정 + 저장</h3>


        <div class="metaFields">
          <label class="field">
            <span data-i18n="operatorLabel">Operator</span>
            <input id="operatorInput" type="text" maxlength="40" autocomplete="off" placeholder="Name" />
          </label>
          <label class="field">
            <span data-i18n="locationLabel">위치</span>
            <select id="locationSelect">
              <option value="Line 1, 1st">Line 1, 1st</option>
              <option value="Line 1, 2nd">Line 1, 2nd</option>
              <option value="Line 2, 1st">Line 2, 1st</option>
              <option value="Line 2, 2nd">Line 2, 2nd</option>
            </select>
          </label>
        </div>

        <div class="syncRow" aria-live="polite">
          <span class="syncDot" id="syncDot"></span>
          <span id="syncText">Cloud: -</span>
        </div>


        <div class="actionGrid">
          <button class="btn ok big" id="btnOK" data-i18n="btnOK">OK</button>
          <button class="btn ng big" id="btnNG" data-i18n="btnNG">NG</button>
          <button class="btn primary big" id="btnCheck" data-i18n="btnCheck">Check (저장)</button>
          <button class="btn warn big" id="btnCancel" data-i18n="btnCancel">취소 (Undo)</button>
        </div>

        <div class="stateRow">
          <div>
            <div class="hint" data-i18n="hint">절차: 판정 선택(OK/NG) → <span class="kbd">Check</span> → (필요 시 Undo)</div>
            <div class="hint" data-i18n="privacyHint">※ 현장 화면에는 시간별 상세 기록을 표시하지 않습니다. (관리자는 내보내기 파일에서 확인)</div>
                      <div class="hint" id="ngReasonLine"><span class="chip ngT"><span data-i18n="ngReasonLabel">NG 사유</span>: <span class="chipStrong" id="ngReasonText">-</span></span></div>
</div>
          <div class="stateBadge" id="currentState"><span class="state-none" data-i18n="stateNone">미선택</span></div>
        </div>
      </section>

      <aside class="panel right">
        <h3 style="margin:0 0 8px 0" data-i18n="panelRight">시간대별 누계</h3>
        <div class="stat">
          <span class="chip"><span data-i18n="sumToday">오늘 누계</span>: <b id="sumTotal">0</b></span>
          <span class="chip okT">OK: <b id="sumOK">0</b></span>
          <span class="chip ngT">NG: <b id="sumNG">0</b></span>
        </div>
        <div class="tableBox">
          <table>
            <thead>
              <tr>
                <th style="width:58px" data-i18n="thHour">시간</th>
                <th style="width:44px" data-i18n="thQty">수량</th>
                <th style="width:36px">OK</th>
                <th style="width:36px">NG</th>
              </tr>
            </thead>
            <tbody id="hourTbody"></tbody>
          </table>
        </div>
      </aside>
    </div>
  </div>

  <!-- Cancel confirmation dialog (Undo) -->
  <dialog id="dlgCancel">
    <div class="dlgWrap">
      <div class="dlgTitle" data-i18n="cancelTitle">취소 확인</div>
      <p class="dlgMsg" data-i18n="cancelMsg">정말 취소하겠습니다?</p>
      <div class="dlgBtns">
        <button class="btn" id="btnNo" data-i18n="no">아니오</button>
        <button class="btn warn" id="btnYes" data-i18n="yes">네</button>
      </div>
    </div>
  </dialog>

  <!-- Clear today dialog (Password) -->
  <dialog id="dlgClear">
    <div class="dlgWrap">
      <div class="dlgTitle" data-i18n="clearTitle">오늘 데이터 삭제</div>
      <p class="dlgMsg" data-i18n="clearMsg">삭제하려면 비밀번호를 입력하세요.</p>
      <div class="fieldLabel" data-i18n="pwdLabel">비밀번호</div>
      <input type="password" id="pwd" inputmode="numeric" autocomplete="off" placeholder="1234" />
      <div class="dlgBtns" style="margin-top:14px">
        <button class="btn" id="btnClearNo" data-i18n="cancel">취소</button>
        <button class="btn warn" id="btnClearYes" data-i18n="confirm">확인</button>
      </div>
    </div>
  </dialog>


  <!-- Settings dialog (Device) -->
  <dialog id="dlgSettings">
    <div class="dlgWrap">
      <div class="dlgTitle" data-i18n="settingsTitle">설정</div>
      <p class="dlgMsg" data-i18n="settingsMsg">이 태블릿의 Device를 선택하세요. (T1~T4)</p>

      <div class="fieldLabel" data-i18n="deviceLabel">Device ID</div>
      <select id="deviceSelect" style="width:100%; background:#0a1325; border:1px solid #1f2937; color:var(--text); padding:12px; border-radius:12px; font-size:16px; font-weight:800;">
        <option value="T1">T1</option>
        <option value="T2">T2</option>
        <option value="T3">T3</option>
        <option value="T4">T4</option>
      </select>

      <div class="hint" style="margin-top:10px" data-i18n="settingsHint">
        ※ 변경 후 새 기록부터 해당 탭(Raw_T1~Raw_T4)으로 저장됩니다.
      </div>

      <div class="dlgBtns" style="margin-top:14px">
        <button class="btn" id="btnSettingsClose" data-i18n="close">닫기</button>
        <button class="btn primary" id="btnSettingsSave" data-i18n="save">저장</button>
      </div>
    </div>
  </dialog>


  <!-- NG Reason select dialog -->
  <dialog id="dlgNg">
    <div class="dlgWrap">
      <div class="dlgTitle" data-i18n="ngSelectTitle">NG 사유 선택</div>
      <p class="dlgMsg" data-i18n="ngSelectMsg">NG 사유를 선택하세요. 없으면 아래에서 추가할 수 있습니다.</p>

      <div class="ngToolbar">
        <select id="ngCatFilter"></select>
        <input id="ngSearch" type="text" placeholder="Search" />
      </div>

      <div class="ngSectionTitle" data-i18n="ngRecentTitle">최근 사용 (Top 5)</div>
      <div class="ngPillsRow" id="ngRecentPills"></div>

      <div class="ngSectionTitle" data-i18n="ngAllTitle">전체 목록</div>
      <div class="ngList" id="ngAllList"></div>

      <div class="ngSectionTitle" data-i18n="ngAddTitle">새 NG 항목 추가</div>
      <div class="ngAddRow">
        <input id="ngAddInput" type="text" placeholder="새 NG 항목" />
        <select id="ngAddCat"></select>
        <button class="btn" id="ngAddBtn" data-i18n="ngAddBtn">추가</button>
      </div>

      <div class="dlgBtns" style="margin-top:14px">
        <button class="btn ghost" id="ngCloseBtn" data-i18n="close">닫기</button>
      </div>
    </div>
  </dialog>




  <!-- Cloud Sync (Apps Script) -->


<script>
    // Splash control: logo 1.5s → text 1.5s (works even in some limited viewers)
    (function(){
      const splash = document.getElementById('splash');
      if(!splash) return;

      const logo = document.getElementById('splashLogo');
      const textWrap = document.getElementById('splashTextWrap');
      let done = false;

      function hideSplash(){
        if(done) return;
        done = true;
        splash.classList.add('hide');
        setTimeout(() => { try { splash.remove(); } catch(_) {} }, 420);
      }

      // Phase 1: show logo only (0~1.5s)
      // Phase 2: show "Made by CHOI" text only (1.5~3.0s)
      setTimeout(() => {
        try {
          if(logo) logo.style.display = 'none';
          if(textWrap) textWrap.style.display = 'block';
        } catch(_) {}
      }, 1500);

      // Total splash duration: 3 seconds
      setTimeout(hideSplash, 3000);

      // Safety fallback: keep this event so JS runs in some WebView cases
      window.addEventListener('pageshow', () => {
        // no-op
      });
    })();

    const I18N = {
      ko: {

        title: 'QC Counter (CHOI)',
        subtitle: '판정 선택 후 Check를 누르면 1건이 기록됩니다. (오른쪽은 시간대별 누계)',
        langLabel: '언어',
        export: 'CSV 내보내기',
        clear: '오늘 데이터 삭제',
        panelLeft: '판정 + 저장',
        panelRight: '시간대별 누계',
        btnOK: 'OK',
        btnNG: 'NG',
        btnCheck: 'Check (저장)',
        btnCancel: '취소 (Undo)',
        stateNone: '미선택',
        hint: '절차: 판정 선택(OK/NG) → <span class="kbd">Check</span> → (필요 시 Undo)',
        operatorLabel: 'Operator',
        operatorPlaceholder: '이름 입력',
        locationLabel: '위치',
        cloudLabel: 'Cloud',
        cloudReady: '연결됨',
        cloudConnecting: '연결 중',
        cloudOffline: '오프라인',
        settingsTitle: '설정',
        settingsMsg: '이 태블릿의 Device를 선택하세요. (T1~T4)',
        deviceLabel: 'Device ID',
        settingsHint: '※ 변경 후 새 기록부터 해당 탭(Raw_T1~Raw_T4)으로 저장됩니다.',
        save: '저장',
        close: '닫기',
        cloudQueue: '전송 대기',
        cloudError: '오류',
        alertNeedOperator: 'Operator 이름을 입력해주세요.',
        alertNeedLocation: '위치를 선택해주세요.',
        privacyHint: '※ 현장 화면에는 시간별 상세 기록을 표시하지 않습니다. (관리자는 내보내기 파일에서 확인)',
        sumToday: '오늘 누계',
        thHour: '시간', thQty: '수량',
        alertSelect: '먼저 OK 또는 NG를 선택하세요.',
        alertNoData: '오늘 데이터가 없습니다.',
        alertNoUndo: '취소할 마지막 Check 기록이 없습니다.',
        cancelTitle: '취소 확인',
        cancelMsg: '정말 취소하겠습니다? (방금 Check 한 1건만 삭제됩니다)',
        yes: '네',
        no: '아니오',
        clearTitle: '오늘 데이터 삭제',
        clearMsg: '삭제하려면 비밀번호를 입력하세요.',
        pwdLabel: '비밀번호',
        pwdWrong: '비밀번호가 틀렸습니다.',
        cancel: '취소',
        confirm: '확인',
        exportedMsg: '내보내기 완료: 파일이 다운로드(Downloads) 폴더에 저장됩니다.'
        ,
        ngReasonLabel: 'NG 사유',
        ngSelectTitle: 'NG 사유 선택',
        ngSelectMsg: 'NG 사유를 선택하세요. 없으면 아래에서 추가할 수 있습니다.',
        ngRecentTitle: '최근 사용 (Top 5)',
        ngAllTitle: '전체 목록',
        ngAddTitle: '새 NG 항목 추가',
        ngSearchPh: '검색',
        ngAddPh: '새 NG 항목 입력',
        ngAddBtn: '추가',
        ngNeedReason: 'NG 사유를 선택해주세요.',
        ngCatAll: '전체 카테고리',
        ngAdded: '추가되었습니다.',
        ngDup: '이미 목록에 있습니다.'

      },
      vi: {

        title: 'QC Counter (CHOI)',
        subtitle: 'Chọn OK/NG rồi nhấn Check để lưu 1 sản phẩm. (Bên phải: cộng dồn theo giờ)',
        langLabel: 'Ngôn ngữ',
        export: 'Xuất CSV',
        clear: 'Xoá dữ liệu hôm nay',
        panelLeft: 'Phán định + Lưu',
        panelRight: 'Cộng dồn theo giờ',
        btnOK: 'OK',
        btnNG: 'NG',
        btnCheck: 'Check (Lưu)',
        btnCancel: 'Huỷ (Undo)',
        stateNone: 'Chưa chọn',
        hint: 'Quy trình: Chọn OK/NG → <span class="kbd">Check</span> → (cần thì Undo)',
        privacyHint: '※ Màn hình không hiển thị chi tiết theo thời gian. (Quản lý xem trong file xuất)',
        sumToday: 'Tổng hôm nay',
        thHour: 'Giờ', thQty: 'SL',
        alertSelect: 'Hãy chọn OK hoặc NG trước.',
        alertNoData: 'Chưa có dữ liệu hôm nay.',
        alertNoUndo: 'Không có bản ghi Check gần nhất để huỷ.',
        cancelTitle: 'Xác nhận huỷ',
        cancelMsg: 'Bạn có chắc muốn huỷ không? (Chỉ xoá 1 bản ghi vừa Check)',
        yes: 'Có',
        no: 'Không',
        clearTitle: 'Xoá dữ liệu hôm nay',
        clearMsg: 'Nhập mật khẩu để xoá.',
        pwdLabel: 'Mật khẩu',
        pwdWrong: 'Sai mật khẩu.',
        cancel: 'Hủy',
        confirm: 'Xác nhận',
        exportedMsg: 'Xuất xong: file được lưu trong thư mục Tải xuống (Downloads).'
        ,
        ngReasonLabel: 'Lý do NG',
        ngSelectTitle: 'Chọn lý do NG',
        ngSelectMsg: 'Chọn lý do NG. Nếu không có, bạn có thể thêm mới bên dưới.',
        ngRecentTitle: 'Dùng gần đây (Top 5)',
        ngAllTitle: 'Danh sách',
        ngAddTitle: 'Thêm mục NG mới',
        ngSearchPh: 'Tìm kiếm',
        ngAddPh: 'Nhập lý do NG mới',
        ngAddBtn: 'Thêm',
        ngNeedReason: 'Vui lòng chọn lý do NG.',
        ngCatAll: 'Tất cả danh mục',
        ngAdded: 'Đã thêm.',
        ngDup: 'Đã tồn tại.'

      }
    };

    const store = {
      get: (k,v)=>{ try { return JSON.parse(localStorage.getItem(k)) ?? v } catch { return v } },
      set: (k,v)=> localStorage.setItem(k, JSON.stringify(v)),
    };
    const pad2 = (n)=> String(n).padStart(2,'0');
    const localDateStr = (d=new Date())=> `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const todayKey = ()=> 'qccounter_' + localDateStr(new Date());

    let selected = null;
    let lang = store.get('qccounter_lang','ko');
    let lastSavedId = store.get('qccounter_lastSavedId', null);

    const btnOK = document.getElementById('btnOK');
    const btnNG = document.getElementById('btnNG');
    const btnCheck = document.getElementById('btnCheck');
    const btnCancel = document.getElementById('btnCancel');
    const currentState = document.getElementById('currentState');
    const hourTbody = document.getElementById('hourTbody');
    const sumTotalEl = document.getElementById('sumTotal');
    const sumOKEl = document.getElementById('sumOK');
    const sumNGEl = document.getElementById('sumNG');

    const btnExport = document.getElementById('btnExport');
    const btnClear = document.getElementById('btnClear');
    const langSel = document.getElementById('lang');

    const operatorInput = document.getElementById('operatorInput');
    const locationSelect = document.getElementById('locationSelect');
    const syncDot = document.getElementById('syncDot');
    const syncText = document.getElementById('syncText');


    const btnSettings = document.getElementById('btnSettings');
    const deviceChip = document.getElementById('deviceChip');

    const dlgSettings = document.getElementById('dlgSettings');
    const deviceSelectEl = document.getElementById('deviceSelect');
    const btnSettingsSave = document.getElementById('btnSettingsSave');
    const btnSettingsClose = document.getElementById('btnSettingsClose');


    const dlgCancel = document.getElementById('dlgCancel');
    const btnYes = document.getElementById('btnYes');
    const btnNo = document.getElementById('btnNo');

    const dlgClear = document.getElementById('dlgClear');
    const btnClearYes = document.getElementById('btnClearYes');
    const btnClearNo = document.getElementById('btnClearNo');
    const pwdEl = document.getElementById('pwd');


    // --- NG Reason UI ---
    const dlgNg = document.getElementById('dlgNg');
    const ngCatFilterEl = document.getElementById('ngCatFilter');
    const ngSearchEl = document.getElementById('ngSearch');
    const ngRecentPillsEl = document.getElementById('ngRecentPills');
    const ngAllListEl = document.getElementById('ngAllList');
    const ngAddInputEl = document.getElementById('ngAddInput');
    const ngAddCatEl = document.getElementById('ngAddCat');
    const ngAddBtnEl = document.getElementById('ngAddBtn');
    const ngCloseBtnEl = document.getElementById('ngCloseBtn');
    const ngReasonLineEl = document.getElementById('ngReasonLine');
    const ngReasonTextEl = document.getElementById('ngReasonText');

    let ngSelectedKey = '';
    let ngSelectedItem = null;


    function applyLang(){
      const d = I18N[lang] || I18N.ko;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if(!key) return;
        if(d[key] !== undefined){
          if(key==='hint') el.innerHTML = d[key];
          else el.textContent = d[key];
        }
      });
      if(!selected){ currentState.innerHTML = `<span class="state-none">${d.stateNone}</span>`; }
  
      try{ if(operatorInput) operatorInput.placeholder = d.operatorPlaceholder || ''; }catch(_){ }
      try{ renderCloudStatus(); }catch(_){ }
      try{ renderDeviceChip(); }catch(_){ }
      try{ ensureNgCatSelectOptions(); renderNgRecentPills(); renderNgDialogLists(); renderNgReasonLine(); }catch(_){ }
    }


    const prefOperatorKey = 'qccounter_operator';
    const prefLocationKey = 'qccounter_location';

    // Device ID for this tablet (T1~T4). Set per tablet.
    // Default device on first run (can be changed in Settings ⚙️)
    const DEFAULT_DEVICE_ID = 'T1';

    // Persisted deviceId (so it doesn't change accidentally)
    let deviceId = store.get('qccounter_deviceId', DEFAULT_DEVICE_ID);
    if(!deviceId) deviceId = DEFAULT_DEVICE_ID;
    store.set('qccounter_deviceId', deviceId);


    function renderDeviceChip(){
      if(!deviceChip) return;
      deviceChip.textContent = `Device: ${deviceId}`;
    }

    function openSettings(force=false){
      if(!dlgSettings) return;
      if(deviceSelectEl) deviceSelectEl.value = deviceId;
      // If dialog is already open, do nothing
      try {
        if(typeof dlgSettings.showModal === 'function'){
          if(!dlgSettings.open) dlgSettings.showModal();
        } else {
          dlgSettings.setAttribute('open','');
        }
      } catch(_) {
        dlgSettings.setAttribute('open','');
      }
    }

    function closeSettings(){
      if(!dlgSettings) return;
      try{ dlgSettings.close(); }catch(_){ dlgSettings.removeAttribute('open'); }
    }

    // Restore last Operator/Location (keeps workflow fast on shopfloor)
    if(operatorInput){
      operatorInput.value = store.get(prefOperatorKey, '');
      operatorInput.addEventListener('change', ()=>{
        store.set(prefOperatorKey, (operatorInput.value || '').trim());
      });
    }
    if(locationSelect){
      const savedLoc = store.get(prefLocationKey, 'Line 1, 1st');
      // If saved value doesn't exist in options, fallback to first.
      locationSelect.value = savedLoc;
      if(!locationSelect.value) locationSelect.value = 'Line 1, 1st';
      locationSelect.addEventListener('change', ()=>{
        store.set(prefLocationKey, locationSelect.value);
      });
    }


// ------------------------------------------------------------
// Device 설정 (단일 index.html로 4대 운영)
// - 최초 실행: 기본값(T1)을 사용
// - 변경: 우측 상단 ⚙️ 설정에서 변경(로컬에 저장됨)
// ------------------------------------------------------------
const DEVICE_OPTIONS = ['T1','T2','T3','T4'];
if(!DEVICE_OPTIONS.includes(deviceId)){
  deviceId = DEFAULT_DEVICE_ID;
  store.set('qccounter_deviceId', deviceId);
  // first run / invalid value → open settings after render
  setTimeout(()=>{ try{ openSettings(true); }catch(_){} }, 250);
}
// secret은 deviceId 기반으로 자동 매핑 (T1_EXO ~ T4_EXO)
function getDeviceSecret(){
  return `${deviceId}_EXO`;
}

renderDeviceChip();


// ------------------------------------------------------------
// NG Catalog (Category + Trilingual: vi/en/ko)
// - Display: KO/VI follows UI language
// - Search: matches vi/en/ko
// - Custom add: stored in localStorage
// ------------------------------------------------------------
const NG_CUSTOM_KEY = 'qccounter_ng_custom_items_v1';
const NG_RECENT_KEY = 'qccounter_ng_recent_v1';

const NG_CATEGORIES = [
  { id:'C1', vi:'Trầy xước & Hư hỏng', en:'Scratch & Damage', ko:'흠집 및 파손' },
  { id:'C2', vi:'Vết bẩn & Keo',        en:'Stain & Glue',     ko:'오염 및 접착제' },
  { id:'C3', vi:'Lắp ráp & Căn chỉnh',  en:'Assembly & Alignment', ko:'조립 및 정렬' },
  { id:'C4', vi:'Linh kiện & Màu sắc',  en:'Parts & Color',    ko:'부품 및 색상' },
  { id:'C5', vi:'May mặc & Hoàn thiện', en:'Sewing & Finishing', ko:'봉제 및 마감' },
];

const NG_ITEMS_DEFAULT = [
  // C1
  { id:'C1_SCRATCH', cat:'C1', vi:'Trầy xước', en:'Scratch', ko:'스크래치' },
  { id:'C1_STRAP_SCRATCH', cat:'C1', vi:'Trầy dây', en:'Strap scratch', ko:'끈 스크래치' },
  { id:'C1_PEELING_SCRATCH', cat:'C1', vi:'Trầy lớt', en:'Peeling scratch', ko:'긁힘/까짐' },
  { id:'C1_RAIL_SCRATCH', cat:'C1', vi:'Trầy máng', en:'Rail scratch', ko:'홈/레일 스크래치' },
  { id:'C1_WHEEL_SCRATCH', cat:'C1', vi:'Trầy bánh xe', en:'Wheel scratch', ko:'바퀴 스크래치' },
  { id:'C1_PULL_HANDLE_SCRATCH', cat:'C1', vi:'Trầy tay kéo', en:'Pull handle scratch', ko:'캐리어 핸들 스크래치' },
  { id:'C1_GRAB_HANDLE_SCRATCH', cat:'C1', vi:'Trầy tay nắm', en:'Grab handle scratch', ko:'손잡이 스크래치' },
  { id:'C1_DENT', cat:'C1', vi:'Móp / Lõm', en:'Dent', ko:'찌그러짐/함몰' },
  { id:'C1_CRACK_BREAK', cat:'C1', vi:'Nứt / Vỡ', en:'Crack / Break', ko:'크랙/깨짐' },

  // C2
  { id:'C2_DIRTY', cat:'C2', vi:'Dơ', en:'Dirty', ko:'오염' },
  { id:'C2_GLUE_STAIN', cat:'C2', vi:'Vết keo', en:'Glue stain', ko:'접착 자국' },
  { id:'C2_GLUE_PEELING', cat:'C2', vi:'Keo lớt', en:'Glue peeling', ko:'본드 번짐/까짐' },
  { id:'C2_RUBBER_GLUE', cat:'C2', vi:'Keo xu', en:'Rubber glue', ko:'고무 본드 자국' },
  { id:'C2_ZIPPER_GLUE', cat:'C2', vi:'Keo dây keo', en:'Zipper glue', ko:'지퍼 본드 자국' },
  { id:'C2_PIPING_GLUE', cat:'C2', vi:'Keo dây nổi', en:'Piping glue', ko:'돌출된 봉제선 본드 자국' },
  { id:'C2_OIL_STAIN', cat:'C2', vi:'Dính dầu', en:'Oil stain', ko:'오일/기름' },

  // C3
  { id:'C3_MISALIGN', cat:'C3', vi:'Lệch / Sai vị trí', en:'Misalign', ko:'정렬 불량/위치 틀어짐' },
  { id:'C3_WRONG_HANDLE_POSITION', cat:'C3', vi:'Sai tay cầm', en:'Wrong handle position', ko:'손잡이 위치 오류' },
  { id:'C3_WRONG_WHEEL_POSITION', cat:'C3', vi:'Sai bánh xe', en:'Wrong wheel position', ko:'바퀴 위치 오류' },
  { id:'C3_PULL_HANDLE', cat:'C3', vi:'Tay kéo', en:'Pull handle', ko:'캐리어 핸들' },
  { id:'C3_GRAB_HANDLE', cat:'C3', vi:'Tay nắm', en:'Grab handle', ko:'손잡이' },
  { id:'C3_GAP', cat:'C3', vi:'Hở / Khe hở', en:'Gap', ko:'틈/간격 불량' },
  { id:'C3_LOOSE_SCREW', cat:'C3', vi:'Lỏng ốc / Lỏng vít', en:'Loose screw', ko:'체결 불량/나사 풀림' },

  // C4
  { id:'C4_MISSING_PART', cat:'C4', vi:'Thiếu linh kiện', en:'Missing part', ko:'부품 누락' },
  { id:'C4_WRONG_PART', cat:'C4', vi:'Sai linh kiện', en:'Wrong part', ko:'부품 오류' },
  { id:'C4_LOGO_ISSUE', cat:'C4', vi:'Lỗi logo / nhãn', en:'Logo issue', ko:'로고/라벨 불량' },
  { id:'C4_LABEL_STICKER', cat:'C4', vi:'Tem', en:'Label / Sticker', ko:'라벨/스티커' },
  { id:'C4_COLOR_MISMATCH', cat:'C4', vi:'Sai màu', en:'Color mismatch', ko:'색상 불일치' },

  // C5
  { id:'C5_SEWING_BREAK', cat:'C5', vi:'Đứt chỉ', en:'Sewing break', ko:'실 끊김' },
  { id:'C5_SEWING_SKIP', cat:'C5', vi:'Bỏ mũi / Mũi may lỗi', en:'Sewing skip', ko:'땀 불량' },
  { id:'C5_WRINKLE', cat:'C5', vi:'Nhăn / Nhíu', en:'Wrinkle', ko:'주름/구김' },
  { id:'C5_STITCH_PROTRUSION', cat:'C5', vi:'Đường may nổi chỉ', en:'Stitch protrusion', ko:'봉제 실 튀어나옴' },
  { id:'C5_DROPPED_STITCH', cat:'C5', vi:'Đường may sụp mí', en:'Dropped stitch', ko:'봉제 이탈/밑빠짐' },
];

function stripDiacritics(s){
  return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
}
function normalizeSearch(s){
  return stripDiacritics(String(s||'')).toLowerCase().trim();
}
function getKoChoseong(ch){
  const code = ch.charCodeAt(0);
  if(code < 0xAC00 || code > 0xD7A3) return '#';
  const cho = Math.floor((code - 0xAC00) / 588);
  const CHO = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
  return CHO[cho] || '#';
}
function getGroupKeyByLang(label){
  const s = String(label||'').trim();
  if(!s) return '#';
  if(lang === 'ko'){
    return getKoChoseong(s[0]);
  }
  const t = stripDiacritics(s).trim();
  const c = (t[0]||'').toUpperCase();
  return (c >= 'A' && c <= 'Z') ? c : '#';
}

function getNgCustom(){
  const x = store.get(NG_CUSTOM_KEY, []);
  return Array.isArray(x) ? x : [];
}
function setNgCustom(arr){
  store.set(NG_CUSTOM_KEY, arr || []);
}
function getNgRecent(){
  const x = store.get(NG_RECENT_KEY, []);
  return Array.isArray(x) ? x : [];
}
function setNgRecent(arr){
  store.set(NG_RECENT_KEY, arr || []);
}

function getAllNgItems(){
  const custom = getNgCustom();
  // prevent accidental overwrite of default IDs
  const safeCustom = custom.filter(it => it && it.id && !NG_ITEMS_DEFAULT.some(d=>d.id===it.id));
  return [...NG_ITEMS_DEFAULT, ...safeCustom];
}
function getCatById(id){ return NG_CATEGORIES.find(c=>c.id===id) || null; }

function getNgLabel(item){
  if(!item) return '';
  if(lang==='ko') return item.ko || item.vi || item.en || '';
  return item.vi || item.ko || item.en || '';
}
function getNgCatLabel(cat){
  if(!cat) return '';
  if(lang==='ko') return cat.ko || cat.vi || cat.en || '';
  return cat.vi || cat.ko || cat.en || '';
}
function itemMatchesQuery(item, q){
  if(!q) return true;
  const nq = normalizeSearch(q);
  const hay = [
    item.vi, item.en, item.ko,
    getCatById(item.cat)?.vi, getCatById(item.cat)?.en, getCatById(item.cat)?.ko
  ].map(normalizeSearch).join(' ');
  return hay.includes(nq);
}

function renderNgReasonLine(){
  const d = I18N[lang] || I18N.ko;
  if(!ngReasonLineEl || !ngReasonTextEl) return;
  if(selected !== 'NG'){
    ngReasonLineEl.style.display = 'none';
    ngReasonTextEl.textContent = '-';
    return;
  }
  ngReasonLineEl.style.display = 'block';
  ngReasonTextEl.textContent = ngSelectedItem ? getNgLabel(ngSelectedItem) : (lang==='ko' ? '미선택' : 'Chưa chọn');
}

function ensureNgCatSelectOptions(){
  if(!ngCatFilterEl || !ngAddCatEl) return;
  const d = I18N[lang] || I18N.ko;

  const makeOpts = (sel, includeAll)=> {
    const prev = sel.value;
    sel.innerHTML = '';
    if(includeAll){
      const oAll = document.createElement('option');
      oAll.value = 'ALL';
      oAll.textContent = d.ngCatAll || (lang==='ko'?'전체 카테고리':'Tất cả danh mục');
      sel.appendChild(oAll);
    }
    for(const c of NG_CATEGORIES){
      const o = document.createElement('option');
      o.value = c.id;
      o.textContent = getNgCatLabel(c);
      sel.appendChild(o);
    }
    // restore if possible
    if(prev && Array.from(sel.options).some(o=>o.value===prev)) sel.value = prev;
    else if(includeAll) sel.value = 'ALL';
  };

  makeOpts(ngCatFilterEl, true);
  makeOpts(ngAddCatEl, false);
}

function openNgDialog(){
  if(!dlgNg) return;
  ensureNgCatSelectOptions();
  // sync placeholders
  const d = I18N[lang] || I18N.ko;
  if(ngSearchEl) ngSearchEl.placeholder = d.ngSearchPh || 'Search';
  if(ngAddInputEl) ngAddInputEl.placeholder = d.ngAddPh || 'Add';
  // default add category to current filter (if not ALL)
  try{
    if(ngCatFilterEl && ngAddCatEl){
      const v = ngCatFilterEl.value;
      if(v && v !== 'ALL') ngAddCatEl.value = v;
    }
  }catch(_){}
  renderNgDialogLists();
  try{
    if(typeof dlgNg.showModal === 'function'){
      if(!dlgNg.open) dlgNg.showModal();
    } else {
      dlgNg.setAttribute('open','');
    }
  }catch(_){
    dlgNg.setAttribute('open','');
  }
}

function closeNgDialog(){
  if(!dlgNg) return;
  try{ dlgNg.close(); }catch(_){ dlgNg.removeAttribute('open'); }
}

function setNgSelected(item){
  ngSelectedItem = item;
  ngSelectedKey = item ? item.id : '';
  // update recent list
  if(ngSelectedKey){
    const recent = getNgRecent().filter(k=>k && k !== ngSelectedKey);
    recent.unshift(ngSelectedKey);
    setNgRecent(recent.slice(0,5));
  }
  renderNgReasonLine();
  renderNgRecentPills();
}

function renderNgRecentPills(){
  if(!ngRecentPillsEl) return;
  const recent = getNgRecent();
  const all = getAllNgItems();
  ngRecentPillsEl.innerHTML = '';
  const show = recent.map(k=>all.find(it=>it.id===k)).filter(Boolean);
  if(!show.length){
    const span = document.createElement('div');
    span.className = 'muted';
    span.style.fontSize = '12px';
    span.textContent = lang==='ko' ? '최근 사용 없음' : 'Chưa có';
    ngRecentPillsEl.appendChild(span);
    return;
  }
  for(const it of show){
    const b = document.createElement('button');
    b.className = 'btn';
    b.style.padding = '8px 10px';
    b.style.borderRadius = '999px';
    b.textContent = getNgLabel(it);
    b.onclick = ()=>{ setNgSelected(it); closeNgDialog(); setSelected('NG', {skipOpen:true}); };
    ngRecentPillsEl.appendChild(b);
  }
}

function renderNgDialogLists(){
  if(!ngAllListEl) return;
  const all = getAllNgItems();

  const cat = (ngCatFilterEl?.value || 'ALL');
  const q = (ngSearchEl?.value || '').trim();

  const filtered = all.filter(it => (cat==='ALL' || it.cat === cat) && itemMatchesQuery(it, q));

  // sort by displayed label
  filtered.sort((a,b)=> getNgLabel(a).localeCompare(getNgLabel(b), lang==='ko'?'ko-KR':'vi-VN'));

  // group
  const groups = new Map();
  for(const it of filtered){
    const gk = getGroupKeyByLang(getNgLabel(it));
    if(!groups.has(gk)) groups.set(gk, []);
    groups.get(gk).push(it);
  }

  const orderedKeys = Array.from(groups.keys()).sort((a,b)=>{
    if(a==='#') return 1;
    if(b==='#') return -1;
    return a.localeCompare(b, lang==='ko'?'ko-KR':'vi-VN');
  });

  ngAllListEl.innerHTML = '';
  if(!filtered.length){
    const div = document.createElement('div');
    div.className = 'muted';
    div.style.fontSize = '12px';
    div.textContent = lang==='ko' ? '검색 결과 없음' : 'Không tìm thấy';
    ngAllListEl.appendChild(div);
    renderNgRecentPills();
    return;
  }

  for(const gk of orderedKeys){
    const h = document.createElement('div');
    h.className = 'ngGroup';
    h.textContent = gk;
    ngAllListEl.appendChild(h);

    for(const it of groups.get(gk)){
      const btn = document.createElement('button');
      btn.className = 'ngItemBtn';
      const catObj = getCatById(it.cat);
      btn.innerHTML = `<div>${escapeHtml(getNgLabel(it))}</div><div class="ngItemSub">${escapeHtml(getNgCatLabel(catObj))}</div>`;
      btn.onclick = ()=>{ setNgSelected(it); closeNgDialog(); setSelected('NG', {skipOpen:true}); };
      ngAllListEl.appendChild(btn);
    }
  }
  renderNgRecentPills();
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
}

function addCustomNgItem(){
  const d = I18N[lang] || I18N.ko;
  const text = (ngAddInputEl?.value || '').trim();
  const cat = (ngAddCatEl?.value || '').trim();
  if(!text || !cat) return;

  const all = getAllNgItems();
  const exists = all.some(it => normalizeSearch(it.ko)===normalizeSearch(text) || normalizeSearch(it.vi)===normalizeSearch(text) || normalizeSearch(it.en)===normalizeSearch(text));
  if(exists){
    alert(d.ngDup || 'Already exists');
    return;
  }

  const id = `CUS_${Date.now()}_${Math.random().toString(16).slice(2,6)}`;
  // store input text into current language field, copy to others (minimal)
  const item = { id, cat, vi: text, en: text, ko: text, custom:true };

  const cur = getNgCustom();
  cur.push(item);
  setNgCustom(cur);

  ngAddInputEl.value = '';
  // set filter to its category for easier selection
  try{
    if(ngCatFilterEl) ngCatFilterEl.value = cat;
  }catch(_){}
  alert(d.ngAdded || 'Added');
  renderNgDialogLists();
}

function initNgUi(){
  ensureNgCatSelectOptions();
  renderNgRecentPills();
  renderNgDialogLists();
  renderNgReasonLine();

  if(ngCatFilterEl) ngCatFilterEl.addEventListener('change', ()=>{
    // align add category
    try{
      const v = ngCatFilterEl.value;
      if(v && v !== 'ALL' && ngAddCatEl) ngAddCatEl.value = v;
    }catch(_){}
    renderNgDialogLists();
  });
  if(ngSearchEl) ngSearchEl.addEventListener('input', ()=> renderNgDialogLists());
  if(ngAddBtnEl) ngAddBtnEl.addEventListener('click', ()=> addCustomNgItem());
  if(ngCloseBtnEl) ngCloseBtnEl.addEventListener('click', ()=> closeNgDialog());
}


// ------------------------------------------------------------
// Core App Logic
// ------------------------------------------------------------
langSel.value = lang;
langSel.addEventListener('change', ()=>{
  lang = langSel.value;
  store.set('qccounter_lang', lang);
  applyLang();
  renderAll();
});

// Settings button (Device)
if(btnSettings){
  btnSettings.addEventListener('click', ()=> openSettings(false));
}
if(btnSettingsClose){
  btnSettingsClose.addEventListener('click', ()=> closeSettings());
}
if(btnSettingsSave){
  btnSettingsSave.addEventListener('click', ()=>{
    const picked = (deviceSelectEl?.value || '').trim().toUpperCase();
    if(picked && DEVICE_OPTIONS.includes(picked)){
      deviceId = picked;
      store.set('qccounter_deviceId', deviceId);
      renderDeviceChip();
      // reflect on export naming etc.
      renderAll();
      // feedback in cloud status line
      setSyncStatus('ok', `${(I18N[lang]||I18N.ko).cloudReady || '연결됨'} / ${deviceId}`);
    }
    closeSettings();
  });
}

btnOK.onclick = ()=> setSelected('OK');
btnNG.onclick = ()=> setSelected('NG');

function setSelected(v, opts={}){
  selected = v;
  if(v === 'OK'){
    // clear NG selection
    ngSelectedKey = '';
    ngSelectedItem = null;
    currentState.innerHTML = '<span class="state-ok">OK</span>';
  } else {
    currentState.innerHTML = '<span class="state-ng">NG</span>';
    // open NG dialog unless explicitly skipped
    if(!opts.skipOpen){
      openNgDialog();
    }
  }
  renderNgReasonLine();
}


function getRows(){ return store.get(todayKey(), []); }
function setRows(rows){ store.set(todayKey(), rows); }

function saveRecord(final){
  const now = new Date();
  const date = localDateStr(now);
  const time = now.toTimeString().slice(0,8);
  const id = `${date}T${time}.${now.getMilliseconds()}_${Math.random().toString(16).slice(2,8)}`;
  const operator = (operatorInput?.value || '').trim();
  const location = (locationSelect?.value || '').trim();
  let ngKey='', ngCategoryId='', ngCategoryKo='', ngCategoryVi='', ngCategoryEn='', ngReasonKo='', ngReasonVi='', ngReasonEn='';
  if(final==='NG' && ngSelectedItem){
    ngKey = ngSelectedItem.id;
    ngCategoryId = ngSelectedItem.cat || '';
    const catObj = getCatById(ngCategoryId);
    ngCategoryKo = catObj?.ko || '';
    ngCategoryVi = catObj?.vi || '';
    ngCategoryEn = catObj?.en || '';
    ngReasonKo = ngSelectedItem.ko || '';
    ngReasonVi = ngSelectedItem.vi || '';
    ngReasonEn = ngSelectedItem.en || '';
  }
  const row = { id, date, time, final, operator, location, deviceId, ngKey, ngCategoryId, ngCategoryKo, ngCategoryVi, ngCategoryEn, ngReasonKo, ngReasonVi, ngReasonEn };
  const rows = getRows();
  rows.push(row);
  setRows(rows);
  lastSavedId = id;
  store.set('qccounter_lastSavedId', lastSavedId);
  return row;
}

function buildHourAgg(rows){
  const hours = Array.from({length:24}, (_,i)=>({h:i, total:0, ok:0, ng:0}));
  let sumT=0, sumO=0, sumN=0;
  for(const r of rows){
    const h = parseInt(String(r.time||'00').slice(0,2),10);
    const obj = hours[h] || hours[0];
    obj.total += 1; sumT += 1;
    if(r.final==='OK'){ obj.ok+=1; sumO+=1; } else { obj.ng+=1; sumN+=1; }
  }
  return {hours, sumT, sumO, sumN};
}

function renderHourStats(){
  const rows = getRows();
  const {hours, sumT, sumO, sumN} = buildHourAgg(rows);
  sumTotalEl.textContent = sumT; sumOKEl.textContent = sumO; sumNGEl.textContent = sumN;
  hourTbody.innerHTML = '';
  const nowH = new Date().getHours();
  for(const obj of hours){
    const hh = obj.h.toString().padStart(2,'0');
    const tr = document.createElement('tr');
    const bold = obj.h===nowH ? 'font-weight:900' : '';
    tr.innerHTML = `<td style="${bold}">${hh}:00</td><td>${obj.total}</td><td class="okT">${obj.ok}</td><td class="ngT">${obj.ng}</td>`;
    hourTbody.appendChild(tr);
  }
}

function renderAll(){ renderHourStats(); }

// --- Export helpers ---
function rowsToCsv(rows){
  const escCsv = (v)=> '"' + String(v ?? '').replace(/"/g,'""') + '"';
  return rows.map(r => (r.length===0 ? '' : r.map(escCsv).join(','))).join('\r\n') + '\r\n';
}
function downloadBlob(blob, filename){
  const a = document.createElement('a');
  const url = URL.createObjectURL(blob);
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 400);
}

btnExport.onclick = ()=>{
  const d = I18N[lang] || I18N.ko;
  const rows = getRows();
  if(rows.length===0){ alert(d.alertNoData); return; }
  const now = new Date();
  const date = localDateStr(now);
  const {hours, sumT, sumO, sumN} = buildHourAgg(rows);

  const summaryRows = [
    ['Date', date],
    ['Device', deviceId],
    ['Total', String(sumT)],
    ['OK', String(sumO)],
    ['NG', String(sumN)],
    [],
    ['Hour', 'Qty', 'OK', 'NG'],
    ...hours.map(h=>[`${String(h.h).padStart(2,'0')}:00`, String(h.total), String(h.ok), String(h.ng)])
  ];
  const detailRows = [
    ['date','time','operator','location','result','deviceId','ngCategory_vi','ngReason_vi','ngCategory_ko','ngReason_ko','ngReason_en'],
...rows.map(r=>[r.date, r.time, r.operator||'', r.location||'', r.final, r.deviceId||'', r.ngCategoryVi||'', r.ngReasonVi||'', r.ngCategoryKo||'', r.ngReasonKo||'', r.ngReasonEn||''])
  ];

  downloadBlob(new Blob([rowsToCsv(summaryRows)], {type:'text/csv;charset=utf-8'}), `QCCount_${deviceId}_${date}_Summary.csv`);
  setTimeout(()=>{
    downloadBlob(new Blob([rowsToCsv(detailRows)], {type:'text/csv;charset=utf-8'}), `QCCount_${deviceId}_${date}_Detail.csv`);
  }, 150);
  alert(d.exportedMsg || 'Exported.');
};

// --- Check / Undo / Clear ---
btnCheck.onclick = async ()=>{
  const d = I18N[lang] || I18N.ko;
  if(!selected){ alert(d.alertSelect); return; }
  const op = (operatorInput?.value || '').trim();
  if(!op){ alert(d.alertNeedOperator); return; }
  const loc = (locationSelect?.value || '').trim();
  if(!loc){ alert(d.alertNeedLocation); return; }

  if(selected === 'NG' && !ngSelectedKey){ alert(d.ngNeedReason || 'Please select NG reason'); openNgDialog(); return; }

  const row = saveRecord(selected);

  // clear NG selection for safety
  ngSelectedKey = '';
  ngSelectedItem = null;

  // reset selection
  selected = null;
  currentState.innerHTML = `<span class="state-none">${d.stateNone}</span>`;
  renderNgReasonLine();
  renderAll();

  // cloud sync best-effort
  try{ await cloudTrySend(row); }catch(_){}
};

btnCancel.onclick = ()=>{
  const d = I18N[lang] || I18N.ko;
  const rows = getRows();
  if(!rows.length || !lastSavedId){ alert(d.alertNoUndo); return; }
  dlgCancel.showModal();
};
btnNo.onclick = ()=> dlgCancel.close();
btnYes.onclick = ()=>{
  const rows = getRows();
  const idx = rows.findIndex(r => r.id === lastSavedId);
  if(idx >= 0){
    rows.splice(idx, 1);
    setRows(rows);
  }
  lastSavedId = rows.length ? rows[rows.length - 1].id : null;
  store.set('qccounter_lastSavedId', lastSavedId);
  dlgCancel.close();
  renderAll();
};

const ADMIN_PWD = '1234';
btnClear.onclick = ()=>{
  pwdEl.value = '';
  dlgClear.showModal();
};
btnClearNo.onclick = ()=> dlgClear.close();
btnClearYes.onclick = ()=>{
  const d = I18N[lang] || I18N.ko;
  if((pwdEl.value || '').trim() !== ADMIN_PWD){
    alert(d.pwdWrong || 'Wrong password');
    return;
  }
  store.set(todayKey(), []);
  lastSavedId = null;
  store.set('qccounter_lastSavedId', lastSavedId);
  dlgClear.close();
  renderAll();
};
    // --- Cloud Sync (Apps Script Web App) ---
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzQX5Z8igCTigO3Xh7LOrXQVBlz0QnNQ5_a-9xfRDUJP2h1sgLSS9SAOdCWb23RiJSPVA/exec";

    const pendingKey = 'qccounter_pending';
    const cloud = { state: 'init', extra: '' };

    function loadPending(){
      try{
        const x = JSON.parse(localStorage.getItem(pendingKey) || '[]');
        return Array.isArray(x) ? x : [];
      }catch(_){ return []; }
    }
    function savePending(arr){
      try{ localStorage.setItem(pendingKey, JSON.stringify(arr || [])); }catch(_){}
    }

    function renderCloudStatus(){
      if(!syncText || !syncDot) return;
      const d = I18N[lang] || I18N.ko;
      const label = d.cloudLabel || 'Cloud';
      let text = label + ': ';
      let cls = '';
      if(cloud.state === 'ready'){ text += (d.cloudReady || 'Ready'); cls = 'ok'; }
      else if(cloud.state === 'offline'){ text += (d.cloudOffline || 'Offline'); cls = 'warn'; }
      else if(cloud.state === 'queue'){
        const n = cloud.extra ? cloud.extra : '';
        text += (d.cloudQueue || 'Queue') + (n ? ` (${n})` : '');
        cls = 'warn';
      }
      else if(cloud.state === 'error'){
        const msg = cloud.extra ? cloud.extra : '';
        text += (d.cloudError || 'Error') + (msg ? ` (${msg})` : '');
        cls = 'ng';
      } else {
        text += '-';
      }
      syncText.textContent = text;
      syncDot.className = 'syncDot ' + cls;
    }
    function setCloudState(state, extra=''){
      cloud.state = state;
      cloud.extra = extra || '';
      renderCloudStatus();
    }

    function buildAppsScriptPayload(row){
      return {
        deviceId: deviceId,
        secret: getDeviceSecret(),
        localDate: row.date,
        localTime: row.time,
        operator: row.operator || '',
        location: row.location || '',
        result: row.final,
        ngKey: row.ngKey || '',
        ngCategory_vi: row.ngCategoryVi || '',
        ngCategory_ko: row.ngCategoryKo || '',
        ngReason_vi: row.ngReasonVi || '',
        ngReason_ko: row.ngReasonKo || '',
        ngReason_en: row.ngReasonEn || ''
      };
    }

    async function postWithTimeout(url, bodyObj, timeoutMs=8000){
      const controller = new AbortController();
      const t = setTimeout(()=>controller.abort(), timeoutMs);
      try{
        // NOTE: Apps Script Web App often doesn't return CORS headers.
        // Using no-cors avoids browser blocking. Response will be opaque.
        await fetch(url, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bodyObj),
          signal: controller.signal
        });
        return true;
      } finally {
        clearTimeout(t);
      }
    }

    async function flushPending(){
      if(!navigator.onLine){ setCloudState('offline'); return; }

      const pending = loadPending();
      if(!pending.length){ setCloudState('ready'); return; }

      setCloudState('queue', String(pending.length));
      // Send sequentially; stop on first error to avoid burning requests.
      for(let i=0; i<pending.length; i++){
        const row = pending[i];
        await postWithTimeout(APPS_SCRIPT_URL, buildAppsScriptPayload(row));
        // remove sent item
        const next = loadPending();
        next.shift();
        savePending(next);
        setCloudState(next.length ? 'queue' : 'ready', next.length ? String(next.length) : '');
      }
    }

    function enqueuePending(row){
      const pending = loadPending();
      pending.push(row);
      savePending(pending);
      setCloudState('queue', String(pending.length));
    }

    async function cloudTrySend(row){
      if(!navigator.onLine){
        enqueuePending(row);
        setCloudState('offline');
        return;
      }
      try{
        await postWithTimeout(APPS_SCRIPT_URL, buildAppsScriptPayload(row));
        // Best effort success (opaque response). If you want strict ACK, you'd need CORS-enabled endpoint.
        setCloudState(loadPending().length ? 'queue' : 'ready', loadPending().length ? String(loadPending().length) : '');
      }catch(err){
        // network / timeout
        enqueuePending(row);
        setCloudState('error', (err && err.name === 'AbortError') ? 'timeout' : 'network');
      }
    }

    function initCloud(){
      // initial status
      setCloudState(navigator.onLine ? (loadPending().length ? 'queue' : 'ready') : 'offline', loadPending().length ? String(loadPending().length) : '');
      // flush when back online
      window.addEventListener('online', ()=>{ flushPending().catch(()=>{}); });
      window.addEventListener('offline', ()=>{ setCloudState('offline'); });
      // try flush on load
      if(navigator.onLine) flushPending().catch(()=>{});
    }


    initNgUi();

    applyLang();
    renderAll();

    // Cloud sync init
    renderCloudStatus();
    initCloud();

    // Service Worker register (for GitHub Pages / installable PWA)
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(() => {});
      });
    }
  </script>
</body>
</html>
